<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student Portal - MarkMyDay</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Global & Body styles */
    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(120deg, #d1f5f0, #fdebd3, #c7ecee);
      background-size: 300% 300%;
      animation: gradientMove 8s ease-in-out infinite alternate;
      padding: 60px 1rem 3rem 1rem; /* top padding for nav space */
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      color: #103f40;
    }

    @keyframes gradientMove {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 100% 50%;
      }
    }

    canvas#bgCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
    }

    /* Navigation bar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: rgba(255 255 255 / 0.95);
      backdrop-filter: saturate(180%) blur(14px);
      box-shadow: 0 3px 14px rgb(0 109 119 / 0.15);
      z-index: 100;
      display: flex;
      justify-content: center;
      user-select: none;
    }

    .nav-list {
      display: flex;
      list-style: none;
      margin: 0 auto;
      padding: 0;
      width: 100%;
      max-width: 700px;
      justify-content: center;
    }

    .nav-list li {
      margin: 0 1.5rem;
      flex-shrink: 0;
    }

    .nav-list a {
      display: block;
      padding: 1.2rem 0;
      font-weight: 700;
      font-size: 1.1rem;
      color: #0a5559;
      border-bottom: 3px solid transparent;
      text-decoration: none;
      transition: color 0.3s, border-color 0.3s;
    }

    .nav-list a:hover,
    .nav-list a.active {
      color: #0c7a7d;
      border-bottom-color: #0c7a7d;
      outline: none;
    }

    /* Logout link styling */
    .nav-list li.logout {
      margin-left: auto;
    }

    .nav-list a.logout-btn {
      display: block;
      padding: 1.2rem 0;
      font-weight: 700;
      font-size: 1.1rem;
      color: #b02a25;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      text-decoration: none;
      transition: color 0.3s, border-color 0.3s;
    }

    .nav-list a.logout-btn:hover,
    .nav-list a.logout-btn:focus {
      color: #7a1815;
      border-bottom-color: #7a1815;
      outline: none;
    }

    /* Responsive Navbar */
    @media (max-width: 720px) {
      .nav-list {
        max-width: 100vw;
        margin: 0 0;
        padding: 0 3vw;
      }

      .nav-list li {
        margin: 0 0.7rem;
      }
    }

    section {
      position: relative;
      max-width: 540px;
      background: rgba(255, 255, 255, 0.80);
      box-shadow: 0 0 34px #3ee8cf33, 0 1px 3px #3956a311;
      border-radius: 23px;
      margin: 2rem auto 2.5rem auto;
      padding: 2.6rem 2.1rem 2rem 2.1rem;
      animation: sectionPop 0.7s;
      z-index: 1;
      backdrop-filter: blur(4.5px);
      scroll-margin-top: 70px;
    }

    @keyframes sectionPop {
      0% {
        opacity: 0;
        transform: scale(0.95);
      }

      100% {
        opacity: 1;
        transform: none;
      }
    }

    section h2 {
      margin-top: 0;
      margin-bottom: 1.1rem;
      font-weight: 700;
      font-size: 1.16rem;
      color: #1d7b8a;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 18px #7ae0d422;
      animation: fadeIn 0.9s;
    }

    .profile-photo {
      width: 66px;
      height: 66px;
      border-radius: 50%;
      background: linear-gradient(135deg, #d1f5f0 50%, #a29bfe 100%);
      box-shadow: 0 0 18px #a8edea55, 0 6px 18px #91a0e688;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #435882;
      font-size: 2.3rem;
      margin: 0 auto 1.2rem auto;
      animation: avatarFadeIn 0.88s;
      transition: box-shadow 0.22s, transform 0.32s;
    }

    .profile-photo:hover {
      box-shadow: 0 0 35px #b6f8f6aa, 0 7px 19px #bdb4fa99;
      transform: rotateZ(-7deg) scale(1.07);
      cursor: pointer;
    }

    .profile p {
      margin: 1.1rem 0 0.5rem 0;
      font-size: 1.01rem;
      color: #22907a;
      font-weight: 600;
    }

    .profile p strong {
      color: #24317e;
    }

    .qr-section {
      text-align: center;
      margin-top: 1.8rem;
      padding: 2rem 1.5rem 1.2rem 1.5rem;
    }

    .qr-label {
      margin-top: 1rem;
      font-size: 1.11rem;
      font-weight: 700;
      color: #028484;
      user-select: text;
      letter-spacing: 0.7px;
      margin-bottom: 1.1rem;
      display: block;
    }

    #qrContainer img {
      margin: 1.08rem auto 0 auto;
      user-select: none;
      border-radius: 1em;
      box-shadow: 0 0 20px #acecfac9, 0 4px 15px #ab9efb22;
      background: #d6f6f8;
      padding: 8px;
      border: 2.3px solid #a7c7ee;
      width: 170px;
      height: 170px;
      transition: box-shadow 0.22s;
    }

    .qr-btnbar {
      margin-top: 1.3rem;
      display: flex;
      justify-content: center;
      gap: 1.4rem;
    }

    .qr-btn {
      padding: 1rem 2.2rem;
      font-size: 1.12rem;
      font-weight: 700;
      background: linear-gradient(90deg, #006d77 20%, #83c5be 100%);
      border: none;
      border-radius: 2.1rem;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 0 14px #43ada4a4;
      transition: background 0.23s, transform 0.18s, box-shadow 0.18s;
      user-select: none;
    }

    .qr-btn:hover,
    .qr-btn:focus {
      background: linear-gradient(120deg, #00595a 30%, #afd8da 100%);
      transform: scale(1.065);
      box-shadow: 0 0 30px #8fefefbd, 0 4px 18px #46444458;
    }

    #qrError {
      color: #b24613;
      margin-top: 20px;
      font-size: 1.1rem;
    }

    .notifications {
      border-left: 5px solid #31b6b9;
      background: #e0f7fa;
      color: #005c63;
      font-weight: 600;
      padding: 1.15em 1.25em 1.1em 1.4em;
      border-radius: 15px;
      margin: 1.2em auto 1.7em auto;
      letter-spacing: 0.3px;
      font-size: 1.03em;
      box-shadow: 0 2px 12px #18a1a767;
      max-width: 540px;
      width: 100%;
      z-index: 10;
    }

    .notifications strong {
      color: #178485;
    }

    .timetable-section {
      background: #f6fcfd;
      border-radius: 14px;
      box-shadow: 0 2px 18px #d8efef33;
      max-width: 680px;
      width: 100%;
      padding: 2.2em 1.5em 1.1em 1.5em;
      margin: 1em auto 2em auto;
      color: #103f40;
      user-select: none;
    }

    .timetable-section h2 {
      color: #168189;
      font-size: 1.75rem;
      margin-bottom: 1em;
      letter-spacing: 0.35px;
      font-weight: 700;
      font-family: 'Roboto', sans-serif;
      padding-left: 0.3em;
    }

    table.timetable {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.07em;
      background: #f6fcfd;
      font-family: 'Roboto', sans-serif;
      box-shadow: 0 0 0 1.3px #d6e9ef;
    }

    table.timetable th {
      background: #d8f2f7;
      color: #18798d;
      font-weight: 700;
      padding: 15px 12px;
      border: 1.3px solid #d6e9ef;
      text-align: center;
      font-size: 1.06em;
    }

    table.timetable td {
      background: #fff;
      color: #205661;
      padding: 14px 12px;
      border: 1.3px solid #d6e9ef;
      text-align: center;
      font-weight: 500;
      font-size: 1.05em;
      letter-spacing: 0.5px;
      vertical-align: middle;
      word-wrap: break-word;
      word-break: break-word;
    }

    table.timetable .time-slot,
    table.timetable th:first-child {
      background: #dbf0f6 !important;
      font-weight: 700;
      font-size: 1.1em;
      color: #168189;
    }

    table.timetable .breakrow td {
      background: #fef6e8 !important;
      color: #be8c28;
      text-align: center;
      font-weight: 700;
      font-style: italic;
      letter-spacing: 1.2px;
      font-size: 1.09em;
      border-top: 2.4px solid #f3e1c1;
      border-bottom: 2.4px solid #f3e1c1;
    }

    @media (max-width: 700px) {
      .timetable-section {
        padding: 1.1em 0.25em 0.5em 0.25em;
        max-width: 97vw;
      }

      table.timetable th,
      table.timetable td {
        font-size: 0.95em;
        padding: 8px 4px;
      }

      .timetable-section h2 {
        font-size: 1.3rem;
        padding-left: 10px;
        margin-bottom: 1em;
      }
    }

    .chart-section {
      text-align: center;
      margin: 2rem auto 4rem auto;
      background: linear-gradient(110deg, #e7f6f6 40%, #e9eaf3 120%);
      border-radius: 20px;
      box-shadow: 0 0 15px #29bebf44;
      padding: 2rem 1.3rem 1.3rem 1.3rem;
      max-width: 540px;
      width: 100%;
      animation: sectionPop 0.9s;
    }

    .chart-section h2 {
      font-size: 1.25rem;
      margin-bottom: 1.2rem;
      color: #0a585a;
      text-shadow: 0 2px 22px #35a9a959;
    }

    .chart-tabs {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1.4rem;
      margin-top: 0.4em;
    }

    .chart-tab {
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      padding: 8px 24px;
      background: linear-gradient(120deg, #27a8a8 40%, #88b0ff 110%);
      border: none;
      border-radius: 18px;
      color: #e9f5f6;
      box-shadow: 0 1px 14px #82abe328;
      transition: background 0.25s, transform 0.18s;
      user-select: none;
      outline: none;
      position: relative;
    }

    .chart-tab.active,
    .chart-tab:focus {
      background: linear-gradient(120deg, #18b9b9 10%, #6881ff 95%);
      color: #eef9fa;
      box-shadow: 0 6px 18px #3aaeffcc;
      transform: scale(1.08);
      z-index: 3;
    }

    #attendanceChart {
      max-width: 380px;
      margin: 0 auto 1.4em auto;
      background: #d5f1ef;
      border-radius: 12px;
      box-shadow: 0 0 20px #30bcbc52;
      padding: 0.65em 0.7em 0.2em 0.7em;
      animation: chartIn 0.6s;
    }

    @keyframes chartIn {
      0% {
        opacity: 0;
        transform: scale(0.88);
      }

      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .no-data-message {
      color: #1a4745;
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 1.2em;
      letter-spacing: 0.2px;
    }

    #alertsContainer {
      max-width: 540px;
      margin: 1rem auto 2rem auto;
      background: #fefcfb;
      border-radius: 20px;
      box-shadow: 0 0 15px #ff6f6188;
      padding: 1.3rem 1.8rem;
      color: #9b2c2c;
      font-weight: 700;
      font-family: 'Roboto', sans-serif;
    }

    .alert-card {
      background: #ffe8e6;
      border-radius: 14px;
      padding: 1rem 1.4rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 12px #ffb1aa88;
      border-left: 6px solid #d8473f;
      animation: alertFadeIn 0.8s ease forwards;
    }

    .alert-card h3 {
      margin-top: 0;
      margin-bottom: 0.3rem;
      color: #b02a25;
      font-size: 1.1rem;
    }

    .alert-card p {
      margin: 0.2rem 0;
      color: #6f1d1b;
      font-weight: 600;
      font-size: 0.95rem;
    }

    @keyframes alertFadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: none;
      }
    }

    /* Floating Chatbot Button and Panel */
    #chat-toggle {
      position: fixed;
      right: 22px;
      bottom: 30px;
      z-index: 9999;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: none;
      background: #1f7aed;
      color: #fff;
      font-size: 29px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.20);
      cursor: pointer;
      transition: background 0.2s;
    }

    #chat-toggle:hover {
      background: #21419a;
    }

    #chat-panel {
      position: fixed;
      right: 22px;
      bottom: 95px;
      z-index: 9999;
      width: 400px;
      max-width: 98vw;
      height: 540px;
      max-height: 77vh;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.30);
      display: none;
      flex-direction: column;
      border: 1.5px solid #dbdbdb;
    }

    #chat-panel-header {
      height: 46px;
      background: #0f172a;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      font: 16px/1.2 system-ui, sans-serif;
    }

    #chat-close {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      margin-left: 8px;
    }

    #chat-iframe {
      border: 0;
      width: 100%;
      height: calc(100% - 46px);
      background: #f8f8fb;
    }

    @media (max-width: 500px) {
      #chat-panel {
        width: 99vw !important;
        right: 0;
      }
    }
  </style>
</head>

<body>
  <canvas id="bgCanvas"></canvas>

  <nav class="navbar" role="navigation" aria-label="Primary">
    <ul class="nav-list">
      <li><a href="#profile" class="nav-link active">Profile</a></li>
      <li><a href="#timetable" class="nav-link">Timetable</a></li>
      <li><a href="#qrcode" class="nav-link">QR Code</a></li>
      <li><a href="#attendance" class="nav-link">Attendance</a></li>
      <li><a href="#alerts" class="nav-link">Alerts</a></li>
      <li class="logout"><a href="#" id="logoutBtn" class="logout-btn" role="button" tabindex="0">Logout</a></li>
    </ul>
  </nav>

  <h1>Welcome to MarkMyDay!</h1>

  <div class="notifications" role="alert" aria-live="polite">
    <strong>Notice:</strong> Today’s guest lecture is at 3 PM. Please mark attendance promptly.
  </div>

  <section id="profile" aria-labelledby="profileLabel" tabindex="0">
    <div class="profile-photo" aria-label="Profile photo with initials">--</div>
    <h2 id="profileLabel">Your Profile</h2>
    <div class="profile">
      <!-- profile info will be loaded here -->
    </div>
  </section>

  <section id="timetable" class="timetable-section" aria-label="Class Timetable">
    <h2>Class Timetable</h2>
    <div style="overflow-x:auto;">
      <table class="timetable" aria-describedby="timetableDesc" role="table">
        <caption id="timetableDesc" class="visually-hidden">Class timetable with breaks</caption>
        <thead>
          <tr>
            <th id="timeCol">Time</th>
            <th id="monCol">Mon</th>
            <th id="tueCol">Tue</th>
            <th id="wedCol">Wed</th>
            <th id="thuCol">Thu</th>
            <th id="friCol">Fri</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="time-slot" headers="timeCol">09:20–10:00</td>
            <td headers="monCol">PYTHON</td>
            <td headers="tueCol">P.A.S</td>
            <td headers="wedCol">D.T.</td>
            <td headers="thuCol">W.T.</td>
            <td headers="friCol">PYTHON</td>
          </tr>
          <tr>
            <td class="time-slot" headers="timeCol">10:00–10:40</td>
            <td headers="monCol">W.T.</td>
            <td headers="tueCol">PYTHON</td>
            <td headers="wedCol">I.T.A</td>
            <td headers="thuCol">D.T.</td>
            <td headers="friCol">W.T.</td>
          </tr>
          <tr class="breakrow">
            <td colspan="6">Break</td>
          </tr>
          <tr>
            <td class="time-slot" headers="timeCol">11:20–12:00</td>
            <td headers="monCol">D.T.</td>
            <td headers="tueCol">W.T.</td>
            <td headers="wedCol">PYTHON</td>
            <td headers="thuCol">P.A.S</td>
            <td headers="friCol">D.T.</td>
          </tr>
          <tr>
            <td class="time-slot" headers="timeCol">12:00–12:30</td>
            <td headers="monCol">I.T.A</td>
            <td headers="tueCol">D.T.</td>
            <td headers="wedCol">W.T.</td>
            <td headers="thuCol">PYTHON</td>
            <td headers="friCol">I.T.A</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <section id="qrcode" class="qr-section" aria-labelledby="qrLabel" tabindex="0">
    <h2 id="qrLabel">Your MarkMyDay QR Code</h2>
    <span class="qr-label">Scan this code for in-class attendance</span>
    <div id="qrContainer"></div>
    <div class="qr-btnbar">
      <button class="qr-btn" id="downloadBtn" aria-label="Download QR Code as image">Download QR Code</button>
      <button class="qr-btn" id="markAttendanceBtn" aria-label="Mark attendance with this QR data">Mark Attendance</button>
    </div>
    <div id="qrError"></div>
  </section>

  <section id="attendance" class="chart-section" aria-labelledby="chartLabel" tabindex="0">
    <h2 id="chartLabel">MarkMyDay Attendance Analytics</h2>
    <div class="chart-tabs" role="tablist">
      <button class="chart-tab active" id="tabMonthly" role="tab" aria-selected="true" aria-controls="attendanceChart">Monthly</button>
      <button class="chart-tab" id="tabWeekly" role="tab" aria-selected="false" aria-controls="attendanceChart">Weekly</button>
    </div>
    <canvas id="attendanceChart" height="138" role="img" aria-label="Attendance chart"></canvas>
  </section>

  <section id="alerts" class="chart-section" aria-labelledby="alertsLabel" tabindex="0">
    <h2 id="alertsLabel">Attendance Risk Alerts</h2>
    <div id="alertsContainer" aria-live="polite">
      Loading alerts...
    </div>
  </section>

  <!-- Floating Chatbot Button and Panel -->
  <button id="chat-toggle" aria-label="Open Chatbot">💬</button>
  <div id="chat-panel">
    <div id="chat-panel-header">
      <span>AI Classroom Chatbot</span>
      <button id="chat-close" aria-label="Close Chatbot Panel">✕</button>
    </div>
    <iframe
      id="chat-iframe"
      src="https://ai-classroom-x.vercel.app/"
      title="AI Classroom Chatbot"
      referrerpolicy="no-referrer"
      allow="clipboard-read; clipboard-write">
    </iframe>
  </div>

  <script>
    // Navigation active tab logic
    const navLinks = document.querySelectorAll('.nav-list a:not(.logout-btn)');
    navLinks.forEach(link => {
      link.addEventListener('click', () => {
        navLinks.forEach(a => a.classList.remove('active'));
        link.classList.add('active');
      });
    });

    window.addEventListener('scroll', () => {
      const sections = ['profile', 'timetable', 'qrcode', 'attendance', 'alerts'];
      let scrollPos = window.scrollY + 80;
      for (let id of sections) {
        let section = document.getElementById(id);
        if (
          section.offsetTop <= scrollPos &&
          section.offsetTop + section.offsetHeight > scrollPos
        ) {
          navLinks.forEach(a => a.classList.remove('active'));
          const currentLink = document.querySelector(`.nav-list a[href="#${id}"]`);
          if (currentLink) currentLink.classList.add('active');
        }
      }
    });

    // Logout button logic
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = "login.html";
    });

    // Load profile and show initials
    async function loadUserProfile() {
      const profilePhoto = document.querySelector('.profile-photo');
      const profileSection = document.querySelector('.profile');
      try {
        const token = localStorage.getItem('token');
        if (!token) throw new Error('Not logged in');
        const response = await fetch('http://localhost:5000/api/user-profile', {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (!response.ok) throw new Error('Failed to fetch profile');
        const { user } = await response.json();
        const names = user.fullname.trim().split(' ');
        const initials = (names[0][0] + (names.length > 1 ? names[1][0] : '')).toUpperCase();
        profilePhoto.textContent = initials;
        profileSection.innerHTML = `
          <p><strong>Enrollment Number:</strong> ${user.username}</p>
          <p><strong>Full Name:</strong> ${user.fullname}</p>
          <p><strong>Email:</strong> ${user.email}</p>
          <p><strong>Branch:</strong> ${user.branch || 'N/A'}</p>
          <p><strong>Classroom:</strong> ${user.classroom || 'N/A'}</p>
        `;

        // Start heartbeat after profile loaded successfully
        startHeartbeat(user);
      } catch (err) {
        console.error(err);
        profilePhoto.textContent = '??';
        profileSection.innerHTML = '<p>Error loading profile.</p>';
      }
    }

    // Load QR Code dynamically
    async function loadMyQrCode() {
      const container = document.getElementById('qrContainer');
      const errDiv = document.getElementById('qrError');
      container.innerHTML = '<span style="color:#006d77;">Loading your QR code from teacher...</span>';
      errDiv.textContent = '';
      try {
        const token = localStorage.getItem('token');
        if (!token) throw new Error('Not logged in');
        const profileResp = await fetch('http://localhost:5000/api/user-profile', {
          headers: { Authorization: `Bearer ${token}` },
        });
        if (!profileResp.ok) throw new Error('Failed to fetch profile');
        const { user } = await profileResp.json();
        const MY_ROLL = user.username;
        const response = await fetch('http://localhost:8080/api/connected_students');
        if (!response.ok) throw new Error('Could not fetch from backend');
        const data = await response.json();
        const mine = (data.connected_students || []).find(
          (s) => s.student_info && s.student_info.roll.replace(/-/g, '') === MY_ROLL.replace(/-/g, '')
        );
        container.innerHTML = '';
        if (!mine) {
          errDiv.textContent =
            "Your QR code is not available right now. Make sure you're present and on the correct device.";
          return;
        }
        const qrImg = document.createElement('img');
        qrImg.src = mine.qr_code;
        qrImg.alt = `QR code for ${user.fullname} (${MY_ROLL})`;
        qrImg.id = 'myQrImg';
        container.appendChild(qrImg);
        window._myQrImg = qrImg;
        window._myQrData = mine.qr_data;
        window._myQrStudent = mine.student_info;
      } catch (e) {
        container.innerHTML = '';
        errDiv.textContent = 'Error loading your QR code: ' + e.message;
      }
    }

    // Download QR code
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const qrImg = window._myQrImg;
      if (!qrImg || !qrImg.src) return alert('QR code not available. Please reload.');
      const a = document.createElement('a');
      a.href = qrImg.src;
      a.download = 'MarkMyDay_QR.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // Mark Attendance
    document.getElementById('markAttendanceBtn').addEventListener('click', async () => {
      if (!window._myQrData) {
        alert('QR code data not loaded.');
        return;
      }
      try {
        const apiUrl = 'http://localhost:8080/api/submit_attendance';
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: window._myQrData,
        });
        if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
        await response.json();
        alert('Attendance marked successfully!');
      } catch (e) {
        alert('Failed to mark attendance. Please try again later.');
        console.error(e);
      }
    });

    // Heartbeat sender: sends presence to backend every 30 seconds
    function startHeartbeat(user) {
      const roll = user.username;
      const deviceName = navigator.userAgent || 'Unknown Device';

      // MAC address not accessible in browser, leaving blank here
      const mac = ''; // Use if available, else keep empty

      async function sendHeartbeat() {
        try {
          const response = await fetch('http://localhost:8080/api/heartbeat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              roll: roll,
              mac: mac.toLowerCase(),
              device_name: deviceName
            }),
          });
          const data = await response.json();
          console.log('Heartbeat sent:', data);
        } catch (error) {
          console.error('Heartbeat error:', error);
        }
      }

      // Send first heartbeat immediately
      sendHeartbeat();

      // Repeat every 30 seconds
      setInterval(sendHeartbeat, 30000);
    }

    // Load profile, QR, and start heartbeat on page load
    window.addEventListener('load', () => {
      loadUserProfile();
      loadMyQrCode();
    });

    // Floating Chatbot Button and Panel
    const toggleBtn = document.getElementById('chat-toggle');
    const chatPanel = document.getElementById('chat-panel');
    const closeBtn = document.getElementById('chat-close');

    toggleBtn.addEventListener('click', () => {
      chatPanel.style.display = (chatPanel.style.display === 'none' || chatPanel.style.display === '') ? 'flex' : 'none';
    });
    closeBtn.addEventListener('click', () => chatPanel.style.display = 'none');
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') chatPanel.style.display = 'none';
    });
  </script>
</body>


</html>
